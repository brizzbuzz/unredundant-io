---
title: Building an OpenAPI Spec Generator
description: Painless Ktor API Documentation
date: '2022-08-16'
thumbnailUrl: 'post/documenting-ktor-apis/thumbnail.jpeg'
publish: true
tags: ['Software', 'Kotlin']
---

[Ktor](https://ktor.io/) has long been one of my favorite web frameworks. It's concise DSL,
asynchronous design, and powerful plugin architecture makes it an awesome choice for building
your next microservice.

Unfortunately, it does not offer OpenAPI generation out of the box. This means devs are left to
hand roll their own documentation, often leading to stale documentation at best, and no documentation
at worst. Since undocumented APIs are about as useful as non-existent APIs, I believe that Ktor needs
a documentation generator that is as awesome as the framework is itself.

The team has long said that OpenAPI support is on their roadmap
(most recently [here](https://blog.jetbrains.com/ktor/2022/02/11/ktor-roadmap-what-s-next/)),
however, it seems a bit crazy how long it has taken, so I decided to go ahead and build my own.
This is why I created [Kompendium](https://github.com/bkbnio/kompendium).

# Getting Started with Kompendium

The easiest way to give Kompendium a test run is to use the GitHub template that I created [here](https://github.com/bkbnio/sourdough-kt).

This will give you a minimal (but fully documented) API out-of-the-box. Simply clone to your local machine and run the following

1. `docker compose up -d` This will launch the database that the dummy app uses under the hood
2. `./gradlew api:run` This will launch the API on port `8080`

Once you have done those two things, go ahead and navigate to `localhost:8080/docs`. You should see an API documentation page

![Sourdough Docs](/post/documenting-ktor-apis/sourdough-example-docs.png)

## But How?

Great question! It's pretty simply, actually. Because of Ktor's [plugin architecture](https://ktor.io/docs/custom-plugins.html)
we are able to define custom plugins that extend the functionality of the framework.

### Installing the Application Plugin

To install Kompendium, users need to install the `NotarizedApplication` plugin to their server.

The example code can be found [here](https://github.com/bkbnio/sourdough-kt/blob/fc9e8b74e6785edfe71a94dc49613ed91e01f162/api/src/main/kotlin/io/bkbn/sourdough/api/Api.kt)

```kotlin
fun main() {
  embeddedServer(
    CIO,
    port = 8080,
    module = Application::mainModule
  ).start(wait = true)
}

private fun Application.mainModule() {
  // install other plugins
  install(NotarizedApplication()) {
    spec = OpenApiSpec(
      info = Info(
        title = "Sourdough API",
        version = "0.0.1",
        description = "A Delicious Starter API",
        termsOfService = URI("https://example.com"),
        contact = Contact(
          name = "Homer Simpson",
          email = "chunkylover53@aol.com",
          url = URI("https://gph.is/1NPUDiM")
        ),
        license = License(
          name = "MIT",
          url = URI("https://github.com/bkbnio/kompendium/blob/main/LICENSE")
        )
      ),
      servers = mutableListOf(
        Server(
          url = URI("http://localhost:8080"),
          description = "Developer instance"
        ),
      )
    )
  }
  // setup routes here
}
```

This gives us the baseline [OpenAPI](https://www.openapis.org) spec metadata that we need in order for our documentation to start
to take form. It also installs the necessary state in our Ktor application for further use. This comes in handy for our next step

### Providing Route Level Documentation

To actually document our individual routes, we must install the `NotarizedRoute` plugin on the routes we wish to document.

Let's say we want to write and document a simple health check endpoint. We could define a `HealthCheckController` object
that exposes a single method `healthCheckHandler`

```kotlin
object HealthCheckController {
  fun Route.healthCheckHandler() {
    route("/") {
      documentation()
      get {
        call.respond(status = HttpStatusCode.OK, HealthCheckModels.Status())
      }
    }
  }

  private fun Route.documentation() {
    install(NotarizedRoute()) {
      tags = setOf("Util")
      get = GetInfo.builder {
        summary("Health Check")
        description("Used predominantly for automated health checks")
        response {
          responseCode(HttpStatusCode.OK)
          responseType<HealthCheckModels.Status>()
          description("Indicates that server is up and running")
        }
      }
    }
  }
}
```

As you can see, all we need to do is execute our `documentation` function on the route itself, and Kompendium will wire
the documentation code into the applications state, ready for us to view as an end user.
